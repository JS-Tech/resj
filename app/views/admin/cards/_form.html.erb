<%= form_for [:admin, @card] do |f| %>
	
	<%= render 'error_messages', object: f.object %>
	<div class="col split2">
		<div class="block">
			<ul>
				<li>
					<%= f.label :name %>
					<%= f.text_field :name %><br>
				</li>
			</ul>
			<ul>
				<li>
					<%= f.label :description %>
					<%= f.text_area :description %><br>
				</li>
			</ul>
			<ul>
				<li>
					<%= f.label :card_id %>
					<%= f.collection_select :card_id, Card.where('card_type_id = ?', CardType.find_by_name("Réseau régional") ), :id, :name, {include_blank: "Aucun"}, {class: "selectize"} %>
				</li>
			</ul>
			<ul>
				<li>
					<%= f.label :street %>
					<%= f.text_field :street %><br>
				</li>
			</ul>
			<ul>
				<li><%= f.label :location_id %></li>
				<li><%= f.collection_select :location_id, Location.all, :id, :full_name, {include_blank: "Select a city"}, {class: "selectize"} %></li>
			</ul>
			<ul>
				<li>
					<%= f.label :latitude %>
					<%= f.text_field :latitude %><br>
				</li>
			</ul>
			<ul>
				<li>
					<%= f.label :longitude %>
					<%= f.text_field :longitude %><br>
				</li>
			</ul>
		</div>
	</div>
	<div class="col split2">
		<div class="block">
			<ul>
				<li>
					<%= f.label :email %>
					<%= f.text_field :email %><br>
				</li>
			</ul>
			<ul>
				<li>
					<%= f.label :place %>
					<%= f.text_field :place %><br>
				</li>
			</ul>
			<ul>
				<li>
					<%= f.label :website %>
					<%= f.text_field :website %><br>
				</li>
			</ul>
		</div>
	</div>
	<%= @card.affiliation %>

	<div class="association_fields autocomplete" data-link="affiliations" >
		<%= f.fields_for(:affiliations, @card.affiliations.any? || @card.affiliations.build) do |affiliation_fields| %>
			<div class="fields">
				<%= affiliation_fields.label :name %>
				<%= affiliation_fields.text_field :name, data: {attr: "name"} %>
				<%= affiliation_fields.hidden_field :_destroy, identifier: "destroy" %>
				<%= link_to_remove_fields "remove" %>
			</div>
		<% end %>
		<%= link_to_add_fields("New affiliation") %>
	</div>

	<div class="block team">
		<div class="label">
			<p>
				<span class="num">8</span> Qui sont les <span class="b">responsables</span> du groupe? La personne de contact sera le référent du groupe. Il est nécessaire de marquer une personne
			</p>
		</div>
		<div class="association_fields autocomplete" data-link="responsables">
			<%= f.fields_for(:responsables, @card.responsables.any? || @card.responsables.build) do |responsables_fields| %>
				<% is_responsable = (!@card.contact.nil? && responsables_fields.object == @card.contact) %>
				<%= content_tag :div, class: "fields" + (" contact" if is_responsable ).to_s do %>
					<div class="field">
						<%= responsables_fields.label :firstname %>
						<%= responsables_fields.text_field :firstname, data: {attr: "firstname"} %>
					</div>
					<div class="field">
						<%= responsables_fields.label :lastname %>
						<%= responsables_fields.text_field :lastname, data: {attr: "lastname"} %>
					</div>
					<div class="field">
						<%= responsables_fields.label :email %>
						<%= responsables_fields.text_field :email %>
					</div>
					<div class="field">
						<%= responsables_fields.hidden_field :_destroy, identifier: "destroy" %>
						<%= link_to_remove_fields "remove" %>
						<%= responsables_fields.hidden_field :is_contact, identifier: "is_contact", value: ("true" if is_responsable) %>
						<%= link_to_add_contact "Mark as contact" unless is_responsable %>
					</div>
				<% end %>
			<% end %>
			<%= link_to_add_fields("New responsable") %>
		</div>
	</div>

	<%= f.fields_for :users do |user_fields| %>
		<div class="fields">
			<%= user_fields.object.full_name %>
			<%= user_fields.hidden_field :_destroy, identifier: "destroy" %>
			<%= link_to_remove_fields "remove" %>
		</div>
	<% end %>

	<%= f.label :card_type_id %>
	<%= f.collection_select :card_type_id, CardType.all, :id, :name, {include_blank: "Category"}, {class: "selectize"} %>

	<%= f.label :tag_names %>
	<%= f.text_field :tag_names, class: "selectize-tags" %>

	<%= f.label :avatar %>
	<%= image_tag(@card.avatar_url) if @card.avatar? %>
	<%= f.file_field :avatar %>
	<%= f.check_box :remove_avatar %>

	<%= f.label :banner %>
	<%= image_tag(@card.banner_url) if @card.banner? %>
	<%= f.file_field :banner %>
	<%= f.check_box :remove_banner %>

	<% if !@card.validated && current_permission.allow_params?(params[:controller], "validated") %>
		<%= f.label :validated %>
		<%= f.check_box :validated, {}, true %>
	<% end %>

	<%= f.submit %>
<% end %>

<%= form_tag user_request_admin_card_path(@card) do %>
	<%= select_tag :user_id, options_from_collection_for_select(User.users - @card.users, :id, :full_name), class: "selectize" %>
	<%= submit_tag %>
<% end %>

<% @card.unconfirmed_card.each do |card_user| %>
	<%= card_user.user.full_name %>
	<%= link_to "Confirm", user_confirmation_admin_card_path(@card, card_user_id: card_user.id, validated: "true"), method: :post %>
	<%= link_to "Refus", user_confirmation_admin_card_path(@card, card_user_id: card_user.id, validated: "false"), method: :post %>
<% end %>

<script type="text/javascript">window.onload=selectize();</script>